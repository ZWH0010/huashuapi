# DyLiveApp API 测试指南

## 测试环境准备

1. 安装Node.js（建议版本 >= 14）
2. 安装依赖：
   ```bash
   cd scripts
   npm install
   ```

## 运行测试

1. 确保API服务已启动并运行在正确的端口（默认为8000）

2. 运行所有测试：
   ```bash
   cd scripts
   npm test
   ```

## 测试报告

测试完成后，会在`test-reports`目录下生成以下文件：

- `report-{timestamp}.html`: HTML格式的详细测试报告
- `report-{timestamp}.json`: JSON格式的原始测试数据
- `summary-{timestamp}.json`: JSON格式的测试摘要

### HTML报告内容

- 测试执行概况
- 请求/响应详情
- 断言结果
- 环境变量
- 响应时间统计
- 失败用例分析

### 测试摘要内容

- 总请求数
- 失败请求数
- 通过的断言数
- 失败的断言数
- 总执行时间
- 平均响应时间

## 测试用例说明

### 用户管理测试

1. 用户注册
   - 测试正常注册流程
   - 验证返回的用户信息

2. 用户登录
   - 测试正常登录流程
   - 验证返回的token
   - 保存token用于后续测试

3. 更新用户信息
   - 测试更新用户名
   - 验证返回的更新后信息

4. 修改密码
   - 测试密码修改流程
   - 验证新密码是否生效

### 标签管理测试

1. 创建标签
   - 测试创建新标签
   - 验证返回的标签信息
   - 保存标签ID用于后续测试

2. 获取标签列表
   - 测试分页功能
   - 测试搜索功能
   - 验证返回的数据格式

3. 更新标签
   - 测试更新标签信息
   - 验证返回的更新后信息

4. 删除标签
   - 测试删除标签
   - 验证删除操作是否成功

### 话术管理测试

1. 创建话术
   - 测试创建新话术
   - 验证返回的话术信息
   - 保存话术ID用于后续测试

2. 获取话术列表
   - 测试分页功能
   - 测试过滤功能
   - 验证返回的数据格式

3. 更新话术
   - 测试更新话术信息
   - 验证返回的更新后信息

4. 创建新版本
   - 测试创建话术新版本
   - 验证版本号递增
   - 验证内容复制

5. 获取版本列表
   - 测试获取话术的所有版本
   - 验证版本列表的完整性

6. 删除话术
   - 测试删除话术
   - 验证删除操作是否成功

### 错误测试

1. 认证错误
   - 测试无效token
   - 验证错误响应

2. 参数验证
   - 测试创建重复标签
   - 验证错误提示

## 自定义测试

### 修改测试数据

可以在`docs/postman/DyLiveApp.postman_environment.json`文件中修改测试环境变量：

```json
{
    "base_url": "修改为实际的API地址",
    "test_phone": "修改为测试用手机号",
    "test_password": "修改为测试密码"
}
```

### 添加新的测试用例

1. 在Postman中创建新的请求
2. 添加必要的测试脚本
3. 导出并更新`DyLiveApp.postman_collection.json`文件

## 持续集成

可以将测试脚本集成到CI/CD流程中：

```yaml
# 示例GitHub Actions配置
name: API Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '14'
      - name: Install dependencies
        run: |
          cd scripts
          npm install
      - name: Run tests
        run: |
          cd scripts
          npm test
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: test-reports
          path: test-reports/
```

## 常见问题

1. **Q: 测试运行失败，显示连接错误**
   A: 检查API服务是否正常运行，以及`base_url`是否配置正确

2. **Q: 某些测试用例始终失败**
   A: 检查测试数据是否有效，以及API是否有相应的权限设置

3. **Q: 测试报告无法生成**
   A: 确保`test-reports`目录存在且有写入权限

4. **Q: 如何调试测试脚本**
   A: 可以在Postman中直接运行和调试单个请求，或使用`console.log`在测试脚本中输出调试信息

## 性能测试

### 负载测试

1. 并发用户测试
   ```bash
   # 使用 Artillery 进行负载测试
   artillery run load-tests/concurrent-users.yml
   ```
   - 模拟100个并发用户
   - 持续时间：30分钟
   - 监控响应时间和错误率

2. 吞吐量测试
   ```bash
   # 使用 k6 进行吞吐量测试
   k6 run throughput-test.js
   ```
   - 测试API每秒处理请求的能力
   - 逐步增加请求速率
   - 监控系统资源使用情况

3. 性能指标
   - 响应时间 < 200ms (P95)
   - 错误率 < 1%
   - CPU使用率 < 70%
   - 内存使用率 < 80%

### 压力测试

1. 极限并发测试
   - 测试系统最大并发用户数
   - 监控系统崩溃点
   - 评估恢复能力

2. 长时间负载测试
   - 持续24小时的中等负载
   - 监控内存泄漏
   - 评估系统稳定性

3. 资源限制测试
   - 数据库连接数上限测试
   - 文件句柄限制测试
   - 网络带宽限制测试

## 安全测试

### 认证和授权测试

1. JWT Token 测试
   - Token 过期处理
   - Token 刷新机制
   - 无效 Token 处理

2. 权限控制测试
   - 越权访问测试
   - 角色权限验证
   - 资源访问控制

3. 会话管理测试
   - 会话超时处理
   - 并发会话控制
   - 会话劫持防护

### 漏洞扫描

1. OWASP Top 10 测试
   - SQL注入防护
   - XSS攻击防护
   - CSRF防护
   - 命令注入防护

2. API安全测试
   - 参数篡改测试
   - 请求伪造测试
   - 敏感信息泄露测试

3. 安全配置测试
   - SSL/TLS配置检查
   - HTTP安全头部检查
   - 错误处理检查

### 数据安全测试

1. 数据加密测试
   - 传输加密测试
   - 存储加密测试
   - 密钥管理测试

2. 敏感数据处理
   - 个人信息脱敏
   - 数据访问审计
   - 数据删除验证

## 并发测试

### 数据一致性测试

1. 并发写入测试
   ```python
   # 使用 pytest-xdist 进行并发测试
   pytest tests/concurrent_write_test.py -n auto
   ```
   - 多用户同时创建话术
   - 多用户同时更新标签
   - 版本号递增测试

2. 读写冲突测试
   - 并发读写话术内容
   - 并发修改用户信息
   - 并发更新统计数据

3. 事务一致性测试
   - 并发事务处理
   - 死锁处理测试
   - 回滚机制测试

### 缓存一致性测试

1. 缓存更新测试
   - 并发缓存更新
   - 缓存失效测试
   - 缓存重建测试

2. 分布式缓存测试
   - 缓存同步测试
   - 缓存一致性验证
   - 缓存穿透测试

### 竞态条件测试

1. 资源竞争测试
   - 并发资源分配
   - 资源锁定机制
   - 资源释放验证

2. 状态转换测试
   - 并发状态更新
   - 状态冲突处理
   - 状态一致性验证

## 测试工具

### 性能测试工具
- Artillery: 负载测试
- k6: 性能基准测试
- Locust: 分布式负载测试

### 安全测试工具
- OWASP ZAP: 漏洞扫描
- Burp Suite: 安全测试
- SQLMap: SQL注入测试

### 并发测试工具
- pytest-xdist: 并发单元测试
- JMeter: 并发功能测试
- wrk: HTTP基准测试

## 监控和报告

### 性能监控
- 响应时间趋势
- 错误率统计
- 资源使用率
- 并发用户数

### 安全监控
- 安全事件日志
- 攻击检测记录
- 漏洞扫描报告

### 并发监控
- 死锁检测
- 竞态条件告警
- 缓存一致性报告

## 最佳实践

1. 性能测试最佳实践
   - 使用生产环境配置
   - 准备足够的测试数据
   - 模拟真实用户行为
   - 监控所有系统组件

2. 安全测试最佳实践
   - 定期进行安全扫描
   - 及时修复发现的漏洞
   - 保持安全补丁更新
   - 记录所有安全测试

3. 并发测试最佳实践
   - 设计幂等API
   - 实现正确的锁机制
   - 使用乐观锁进行并发控制
   - 充分测试边界条件 